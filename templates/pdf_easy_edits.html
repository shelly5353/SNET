{% extends "base.html" %}

{% block title %}PDF Easy Edits - SNET{% endblock %}

{% block content %}
<div class="container-fluid mt-5 pt-5 pdf-editor-container">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">PDF Easy Edits</h2>
                    <button class="btn btn-outline-light" onclick="reloadIframe()">
                        <i class="fas fa-sync-alt"></i> רענון
                    </button>
                </div>
                <div class="card-body p-0" id="pdfEditorContainer">
                    <div id="iframeWrapper">
                        <iframe 
                            id="pdfEditorFrame"
                            src="https://pdf-easy-edits.onrender.com" 
                            style="width: 100%; height: calc(100vh - 250px); border: none;"
                            title="PDF Easy Edits Application"
                            allowfullscreen
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
                            onload="handleIframeLoad()"
                            onerror="handleIframeError()">
                        </iframe>
                    </div>
                    <div id="loadingOverlay" class="loading-overlay">
                        <div class="loading-content">
                            <div class="loading-spinner"></div>
                            <p class="mt-3">טוען את עורך ה-PDF...</p>
                        </div>
                    </div>
                    <div id="errorOverlay" class="error-overlay" style="display: none;">
                        <div class="error-content">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <p>אירעה שגיאה בטעינת העורך</p>
                            <button class="btn btn-primary mt-3" onclick="reloadIframe()">
                                <i class="fas fa-redo"></i> נסה שוב
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.pdf-editor-container {
    height: calc(100vh - 100px);
    overflow: hidden;
}

#pdfEditorContainer {
    position: relative;
    height: 100%;
    background: #fff;
}

#iframeWrapper {
    position: relative;
    width: 100%;
    height: 100%;
}

#pdfEditorFrame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}

.loading-overlay, .error-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading-content, .error-content {
    text-align: center;
    color: white;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-overlay {
    background: rgba(0,0,0,0.9);
}

.error-content i {
    color: #dc3545;
}

.btn-outline-light {
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: white;
}
</style>

<script>
let iframeLoadAttempts = 0;
const MAX_LOAD_ATTEMPTS = 3;
const LOAD_TIMEOUT = 30000; // 30 seconds

function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('errorOverlay').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showError() {
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('errorOverlay').style.display = 'flex';
}

function reloadIframe() {
    const iframe = document.getElementById('pdfEditorFrame');
    iframeLoadAttempts = 0;
    showLoading();
    iframe.src = iframe.src;
}

function handleIframeLoad() {
    const iframe = document.getElementById('pdfEditorFrame');
    try {
        // בדיקה שהאפליקציה נטענה בהצלחה
        if (iframe.contentWindow.document.readyState === 'complete') {
            hideLoading();
            iframeLoadAttempts = 0;
        } else {
            iframeLoadAttempts++;
            if (iframeLoadAttempts >= MAX_LOAD_ATTEMPTS) {
                showError();
            }
        }
    } catch (e) {
        console.log('Cannot access iframe content due to same-origin policy');
        hideLoading();
    }
}

function handleIframeError() {
    iframeLoadAttempts++;
    if (iframeLoadAttempts >= MAX_LOAD_ATTEMPTS) {
        showError();
    } else {
        setTimeout(reloadIframe, 2000);
    }
}

// טעינה ראשונית
document.addEventListener('DOMContentLoaded', function() {
    showLoading();
    
    // טיימאאוט לטעינה
    setTimeout(function() {
        if (document.getElementById('loadingOverlay').style.display === 'flex') {
            handleIframeError();
        }
    }, LOAD_TIMEOUT);
});

// טיפול בשינוי גודל המסך
window.addEventListener('resize', function() {
    const iframe = document.getElementById('pdfEditorFrame');
    if (iframe) {
        iframe.style.height = `${window.innerHeight - 250}px`;
    }
});
</script>
{% endblock %} 